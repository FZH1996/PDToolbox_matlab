function dz = bnn(t,z)

global G



% extract matrix of strategies
n = max(G.S);
x_n = vec2mat(z,n);
x = zeros(G.P, n);

for p = 1 : G.P
    x(p, :) = x_n(p, :) * G.m(p);
end

% calculate fitness of each strategy
F_ = zeros(G.P, n);
F_mean = zeros(G.P, 1);
F = zeros(G.P, n);

F_excess = zeros(G.P, n);
F_excess_mean = zeros(G.P, n);

x_dot_v = zeros(G.P* n, 1);


for p = 1 : G.P
    F(p, :) = G.f(x, p);
    F_mean(p) = F(p, :) * x_n(p, :)';

    F_excess(p,:) = max( F_(p, :) - F_mean(p), 0 );
    
%    for s = 1 : G.S(p)
%        F_excess(p, s) = max( F_(p, s) - F_mean(p), 0 ) ;
%        F_excess_mean(p) = F_excess_mean(p) + F_excess(p, s);
%    end

% calculate update in the strategy


    for s = 1 : G.S(p)
        %x_dot(p, s) = F_excess(p, s) - F_excess_mean(p) * x_n(p, s);
        x_dot_v( (p-1)*n + s) = F_excess(p, s) - F_excess_mean(p) * x_n(p, s);
    end
end

dz = [x_dot_v];


